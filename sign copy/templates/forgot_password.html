<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parolayı Unuttunuz - Neet Up</title>
    <link rel="icon" href="/static/NeetUp.PNG" type="image/png">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-placeholder::placeholder { color: #a0aec0; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-500 to-blue-800 min-h-screen flex items-center justify-center p-4">

    <!-- Form Container -->
    <div class="w-full max-w-md bg-white/10 backdrop-blur-md rounded-2xl shadow-2xl p-8 space-y-6">

        <!-- Header -->
        <div class="text-center">
            <h1 class="text-3xl font-bold text-white">Parolayı Unuttunuz</h1>
            <p class="text-blue-200 mt-2">Hesabınıza geri dönmek için buraya geldiniz.</p>
        </div>

        <!-- Step 1: Find Account -->
        <form id="find-account-form" class="space-y-4">
            <p class="text-blue-100 text-sm">Kullanıcı adını ve e-posta adresini girerek hesabınızı bulabilirsiniz.</p>
            <div>
                <label for="username" class="block text-sm font-medium text-blue-100 mb-2">Kullanıcı Adı</label>
                <input type="text" id="username" name="username" placeholder="Kullanıcı adınız" class="w-full px-4 py-3 bg-gray-900/50 border border-transparent rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-400" required>
            </div>
            <div>
                <label for="email" class="block text-sm font-medium text-blue-100 mb-2">E-Posta Adresi</label>
                <input type="email" id="email" name="email" placeholder="E-Posta adresiniz" class="w-full px-4 py-3 bg-gray-900/50 border border-transparent rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-400" required>
            </div>
            <div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                    Hesabımı Bul
                </button>
            </div>
        </form>

        <!-- Step 2: Answer Question & Reset Password (Initially Hidden) -->
        <form id="reset-password-form" class="space-y-4 hidden">
            <!-- Hidden input for email, auto-filled by JS after step 1 -->
            <input type="hidden" id="reset-email" name="email">
            <!-- Security question will be displayed here by JavaScript -->
            <div id="security-question-display" class="bg-gray-900/50 p-4 rounded-lg">
                <p class="text-sm font-medium text-blue-100 mb-2">Güvenlik Sorusu:</p>
                <p id="question-text" class="text-white"></p>
            </div>

            <div>
                <label for="security-answer" class="block text-sm font-medium text-blue-100 mb-2">Cevap</label>
                <input type="text" id="security-answer" name="security_answer" placeholder="Cevabınız" class="w-full px-4 py-3 bg-gray-900/50 border border-transparent rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-400" required>
            </div>

            <hr class="border-blue-400/50 my-4">

            <div>
                <label for="new-password" class="block text-sm font-medium text-blue-100 mb-2">Yeni Parola</label>
                <input type="password" id="new-password" name="new_password" placeholder="••••••••" class="w-full px-4 py-3 bg-gray-900/50 border border-transparent rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-400" required>
            </div>
            <div>
                <label for="confirm-new-password" class="block text-sm font-medium text-blue-100 mb-2">Yeni Parolayı Onayla</label>
                <input type="password" id="confirm-new-password" name="confirmNewPassword" placeholder="••••••••" class="w-full px-4 py-3 bg-gray-900/50 border border-transparent rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-400" required>
            </div>
            <div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                    Parolayı Sıfırla
                </button>
            </div>
        </form>

        <!-- Login Link -->
        <div class="text-center text-blue-200">
            <p> Parolayı unutmadınız mı? <a href="/signin-page" class="font-semibold text-white hover:underline">Giriş Yap</a></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const findAccountForm = document.querySelector('#find-account-form');
            const resetPasswordForm = document.querySelector('#reset-password-form');
            const questionText = document.querySelector('#question-text');

            // --- Step 1: Find Account and Get Security Question ---
            findAccountForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const formData = new FormData(findAccountForm);
                const data = Object.fromEntries(formData.entries());

                try {
                    const response = await fetch('/api/auth/request-reset', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        // Display the security question from the server
                        const questionMap = {
                            "pet_name": " Evcil hayvanınızın adı nedir?",
                            "mother_maiden_name": "Annenizin adı nedir?",
                            "first_school": "İlkokulunuzun adı nedir?"
                        };
                        questionText.textContent = questionMap[result.security_question] || "Bilinmeyen soru";
                        
                        // Set the email for the reset form (needed for backend validation)
                        document.getElementById('reset-email').value = data.email;
                        // Hide step 1 and show step 2
                        findAccountForm.classList.add('hidden');
                        resetPasswordForm.classList.remove('hidden');
                    } else {
                        alert('Hata: ' + result.message);
                    }
                } catch (error) {
                    console.error('İstek başarısız:', error);
                    alert('Bir hata oluştu. Lütfen tekrar deneyin.');
                }
            });

            // --- Step 2: Submit Answer and New Password ---
            resetPasswordForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                // Only use reset form data, as email is now included as a hidden input
                const resetData = Object.fromEntries(new FormData(resetPasswordForm).entries());
                // Optionally, you can validate here that all required fields are present
                try {
                    const response = await fetch('/api/auth/reset-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(resetData)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert(result.message);
                        // Redirect to the sign-in page on success
                        window.location.href = '/signin-page';
                    } else {
                        alert('Hata: ' + result.message);
                    }
                } catch (error) {
                    console.error('İstek başarısız:', error);
                    alert('Bir hata oluştu. Lütfen tekrar deneyin.');
                }
            });
        });
    </script>
</body>
</html>